<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HAF Übersichtskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body { height:100%; margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #map { width:100%; height:100vh; }
    .info-box { position:absolute; left:12px; top:12px; z-index:1000; background:rgba(255,255,255,0.95); padding:8px 12px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.12); pointer-events:none; }
    .legend { background: white; padding:8px 10px; border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,0.15); font-size:14px; }
    @media (max-width:700px){ .legend { font-size:13px; padding:6px 8px; } }
  </style>
</head>
<body>

<div id="map" role="application" aria-label="Interaktive Übersichtskarte"></div>
<div class="info-box" id="infobox">Bewege die Maus über eine Region</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* === Konfiguration === */
const REGIONS_GEOJSON_FILE = 'regionen.geojson';        // interaktive Regionen (5 Features mit url)
const AUSTRIA_GEOJSON_FILE = 'bundeslaender.geojson';  // nur Hintergrund (9 Features)

/* DOM */
const infoBox = document.getElementById('infobox');

/* Karte */
const map = L.map('map', { minZoom:6, maxZoom:13, scrollWheelZoom:true }).setView([47.5,13.3],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

/* Farben / Style */
const COLOR_FORERUNNER = "#d9534f", COLOR_FOLLOWER = "#0275d8", COLOR_DEFAULT = "#6c757d";
function styleByType(feature) {
  const t = (feature.properties && feature.properties.type || '').toLowerCase();
  let fill = COLOR_DEFAULT;
  if (t === 'forerunner') fill = COLOR_FORERUNNER;
  if (t === 'follower') fill = COLOR_FOLLOWER;
  return { color:'#ffffff', weight:1, fillColor: fill, fillOpacity:0.65, className: 'region-polygon' };
}

/* --- Nicht-interaktive Bundesländer (Hintergrund) laden --- */
fetch(AUSTRIA_GEOJSON_FILE)
  .then(r => {
    if (!r.ok) throw new Error('Fehler beim Laden der Bundesländer: ' + r.status);
    return r.json();
  })
  .then(data => {
    // style: outline, transparent fill; interactive: false -> keine Events
    L.geoJSON(data, {
      style: function(){ return { color:'#333', weight:1, fillOpacity:0 }; },
      interactive: false // WICHTIG: keine Interaktion
    }).addTo(map);
  })
  .catch(err => {
    console.warn('bundeslaender.geojson nicht geladen oder fehlgeschlagen:', err);
    // ignore - Karte funktioniert trotzdem
  });

/* --- Regions Layer (interaktiv) --- */
/* expose global für Debug / Console */
window.regionsLayer = null;

/* Link-Erkennungsliste (prüft nacheinander) */
const LINK_CANDIDATES = ['url','website','link','homepage','href','site','website_url','portal','web','uri','home'];

/* Link öffnen (öffnet in neuem Tab). Wenn du statt neuem Tab gleiches Tab willst: window.location.href = url; */
function openLink(url) {
  if (!url) return false;
  url = url.toString().trim();
  if (/^\/[^\/]/.test(url)) { window.open(url, '_blank', 'noopener'); return true; }
  if (!/^[a-zA-Z]+:\/\//.test(url)) url = 'https://' + url;
  window.open(url, '_blank', 'noopener');
  return true;
}

/* onEachFeature für Regionen */
function onEachRegion(feature, layer) {
  const name = (feature.properties && feature.properties.name) ? feature.properties.name : 'Region';
  layer.bindTooltip(name, { sticky:true, direction:'auto' });

  layer.on({
    mouseover(e) {
      e.target.setStyle({ weight:3, fillOpacity:0.85 });
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) e.target.bringToFront();
      infoBox.textContent = name;
    },
    mouseout(e) {
      if (window.regionsLayer) window.regionsLayer.resetStyle(e.target);
      infoBox.textContent = 'Bewege die Maus über eine Region';
    },
    click(e) {
      const props = (feature.properties || {});
      for (const k of LINK_CANDIDATES) {
        if (props[k] && props[k].toString && props[k].toString().trim().length) {
          openLink(props[k]);
          return;
        }
      }
      if (props.slug && props.slug.toString().trim()) { openLink('/' + props.slug.toString().trim()); return; }
      if (e.target && e.target.getBounds) map.fitBounds(e.target.getBounds(), { padding:[20,20] });
    }
  });
}

/* enforce pointer-events (nur für regionsLayer) */
function enforcePointerEventsOnRegions() {
  try {
    if (!window.regionsLayer) {
      // fallback: ensure any SVG paths in #map accept pointer-events
      document.querySelectorAll('#map svg').forEach(sv => {
        sv.style.pointerEvents = 'auto';
        sv.querySelectorAll('g').forEach(g => { g.style.pointerEvents = 'auto'; });
        sv.querySelectorAll('path').forEach(p => { p.style.pointerEvents = 'auto'; p.style.cursor='pointer'; });
      });
      return;
    }
    window.regionsLayer.eachLayer(function(layer){
      if (layer && layer._path) {
        layer._path.style.pointerEvents = 'auto';
        layer._path.style.cursor = 'pointer';
      }
    });
  } catch (err) {
    console.warn('enforcePointerEventsOnRegions error', err);
  }
}

/* DOM-Fallback: direkt an path click binden (nur regionsLayer) */
function attachDomFallbackToRegions() {
  try {
    if (!window.regionsLayer || typeof window.regionsLayer.eachLayer !== 'function') return;
    window.regionsLayer.eachLayer(function(layer){
      try {
        if (layer && layer._path && !layer._path.__domClickAttached) {
          layer._path.addEventListener('click', function(evt){
            try {
              const props = (layer.feature && layer.feature.properties) ? layer.feature.properties : {};
              for (const k of LINK_CANDIDATES) {
                if (props[k] && props[k].toString && props[k].toString().trim().length) {
                  openLink(props[k]); return;
                }
              }
              if (props.slug && props.slug.toString().trim()) { openLink('/' + props.slug.toString().trim()); return; }
            } catch(e){ console.warn('DOM-Fallback handler error', e); }
          }, false);
          layer._path.__domClickAttached = true;
        }
      } catch(e){}
    });
  } catch (err) { console.warn('attachDomFallbackToRegions error', err); }
}

/* global path->layer handler aber NUR in regionsLayer (extra fallback) */
(function attachGlobalPathClickHandlerForRegions(){
  const mapEl = document.getElementById('map');
  if (!mapEl) return;
  const handler = function(e){
    try {
      const el = document.elementFromPoint(e.clientX, e.clientY);
      let path = el;
      while (path && path.tagName !== 'path') path = path.parentElement || path.parentNode;
      if (!path) return;
      // Try to find layer only among regionsLayer
      const candidateLayers = (window.regionsLayer && typeof window.regionsLayer.getLayers === 'function')
        ? window.regionsLayer.getLayers()
        : [];
      const pid = path._leaflet_id;
      const layer = candidateLayers.find(l => l && (l._path === path || l._leaflet_id === pid || (l._path && l._path._leaflet_id === pid)));
      if (!layer) return;
      const props = (layer.feature && layer.feature.properties) ? layer.feature.properties : {};
      for (const k of LINK_CANDIDATES) {
        if (props[k] && props[k].toString && props[k].toString().trim().length) {
          window.open(props[k].toString().trim(), '_blank', 'noopener'); return;
        }
      }
      if (props.slug && props.slug.toString().trim()) { window.open('/' + props.slug.toString().trim(), '_blank', 'noopener'); return; }
    } catch (err) { /* ignore */ }
  };
  mapEl.addEventListener('click', handler, true);
  console.log('Global regions-only path->layer click handler attached.');
})();

/* --- Load regions GeoJSON (interaktiv) --- */
fetch(REGIONS_GEOJSON_FILE)
  .then(r => { if (!r.ok) throw new Error('Fehler beim Laden der Regionen: ' + r.status); return r.json(); })
  .then(data => {
    if (!data || !data.features) throw new Error('Keine Features in Regionen gefunden');
    // regionsLayer als interaktives GeoJSON
    window.regionsLayer = L.geoJSON(data, {
      style: styleByType,
      onEachFeature: onEachRegion
    }).addTo(map);

    // zoom to regions
    try {
      const b = window.regionsLayer.getBounds();
      if (b && b.isValid && !b.isEmpty()) map.fitBounds(b, { padding:[30,30] });
    } catch(e){/* ignore */ }

    setTimeout(()=>map.invalidateSize(), 200);

    // apply fixes & fallbacks (nur für regions)
    enforcePointerEventsOnRegions();
    attachDomFallbackToRegions();

    // reapply bei map events
    map.on('zoomend moveend layeradd layerremove', function(){
      enforcePointerEventsOnRegions();
      attachDomFallbackToRegions();
    });

    // MutationObserver auf overlay pane (best-effort)
    const overlay = document.querySelector('.leaflet-pane.leaflet-overlay-pane');
    if (overlay) {
      const mo = new MutationObserver(() => {
        if (window.__pe_timeout) clearTimeout(window.__pe_timeout);
        window.__pe_timeout = setTimeout(function(){
          enforcePointerEventsOnRegions();
          attachDomFallbackToRegions();
        }, 80);
      });
      mo.observe(overlay, { childList:true, subtree:true, attributes:true });
    }
  })
  .catch(err => {
    console.error('Fehler beim Laden der Regionen:', err);
    const wrapper = document.getElementById('map');
    const note = document.createElement('div');
    note.style.padding = '20px';
    note.style.color = '#a00';
    note.style.background = '#fff';
    note.style.maxWidth = '640px';
    note.style.margin = '20px auto';
    note.style.borderRadius = '6px';
    note.innerText = 'Die Regions-Datei konnte nicht geladen werden. Bitte prüfe, ob "regionen.geojson" im selben Ordner liegt.';
    wrapper.appendChild(note);
  });

/* kleine Legend (optional) */
const legend = L.control({ position: 'bottomright' });
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = '<strong>Legende</strong>';
  const add = (color,label) => {
    const item = document.createElement('div');
    item.className = 'item';
    const sw = document.createElement('span');
    sw.className = 'swatch';
    sw.style.background = color;
    const txt = document.createElement('span');
    txt.textContent = label;
    item.appendChild(sw);
    item.appendChild(txt);
    div.appendChild(item);
  };
  add(COLOR_FORERUNNER, 'Forerunner-Region');
  add(COLOR_FOLLOWER, 'Follower-Region');
  return div;
};
legend.addTo(map);

/* Accessibility: Enter öffnet Link der Region unter Kartenmittelpunkt */
document.addEventListener('keydown', function(e){
  if (e.key === 'Enter' && window.regionsLayer) {
    const center = map.getCenter();
    window.regionsLayer.eachLayer(function(layer){
      if (layer && layer.getBounds && layer.getBounds().contains(center)) {
        const props = (layer.feature && layer.feature.properties) ? layer.feature.properties : {};
        for (const k of LINK_CANDIDATES) {
          if (props[k] && props[k].toString && props[k].toString().trim().length) {
            openLink(props[k]); return;
          }
        }
        if (props.slug && props.slug.toString().trim()) { openLink('/' + props.slug.toString().trim()); return; }
      }
    });
  }
});
</script>
</body>
</html>
