<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HAF Übersichtskarte — minimal</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;background:#fff}
    /* Karte füllt Viewport, kein zusätzlicher Rand */
    #map{width:100%;height:100vh;display:block;margin:0;padding:0;box-sizing:border-box;background:#fff}
    /* kleine Legende-Stile (optional) */
    .legend{background:#fff;padding:8px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.12);font-size:14px}
    .swatch{display:inline-block;width:18px;height:12px;border-radius:2px;margin-right:8px;vertical-align:middle}
  </style>
</head>
<body>
<div id="map" role="application" aria-label="Interaktive Übersichtskarte"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* Minimal, kompakt und iframe-sicher
   - keine sichtbare Basemap (transparenter TileLayer)
   - Klick auf Region öffnet genau einen Link (first match)
   - tight fit auf Österreich, responsive auf Resize
*/

/* Dateien */
const AUSTRIA_GEOJSON_FILE = 'bundeslaender.geojson';
const REGIONS_GEOJSON_FILE = 'regionen.geojson';

/* Farben */
const COLOR_FORERUNNER = '#7b8ca0';
const COLOR_FOLLOWER   = '#a1bdda';
const COLOR_DEFAULT    = '#6c757d';

/* Karte */
const map = L.map('map', { minZoom: 6, maxZoom: 13, scrollWheelZoom: true }).setView([47.5,13.3],7);

/* transparent tilelayer: verhindert Leaflet's extra white-space behavior */
L.tileLayer('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8z8AIAgMAnwPf4gAAAABJRU5ErkJggg==', {
  minZoom: 6, maxZoom: 13, attribution: ''
}).addTo(map);

/* Panes */
map.createPane('countryPane'); map.getPane('countryPane').style.zIndex = 200;
map.createPane('regionsPane'); map.getPane('regionsPane').style.zIndex = 650;
if (map.getPane('tooltipPane')) map.getPane('tooltipPane').style.zIndex = 1200;

/* iframe-safe open (top window) */
function openInTopWindow(url){
  if(!url) return false;
  url = String(url).trim();
  if(/^\/[^\/]/.test(url)){
    try{ window.top.location.href = url; }catch(e){ window.location.href = url; }
    return true;
  }
  if(!/^[a-zA-Z]+:\/\//.test(url)) url = 'https://' + url;
  try{ window.top.location.href = url; }catch(e){ window.location.href = url; }
  return true;
}

/* Styles */
function austriaStyle(){ return { color:'#fff', weight:2, fillColor:'#eaeaea', fillOpacity:1, interactive:false, pane:'countryPane' }; }
function regionStyle(feature){
  const t = (feature && feature.properties && feature.properties.type || '').toLowerCase();
  let fill = COLOR_DEFAULT;
  if(t==='forerunner') fill = COLOR_FORERUNNER;
  if(t==='follower') fill = COLOR_FOLLOWER;
  return { color:'#fff', weight:2, fillColor:fill, fillOpacity:1, pane:'regionsPane' };
}

/* tight fit helper (uses bounds, sets view to exact zoom) */
const FIT_PADDING = [0,0];
function fitToBoundsTight(bounds){
  if(!bounds || (typeof bounds.isValid==='function' && !bounds.isValid())) return;
  try{ map.invalidateSize(); }catch(e){}
  // best zoom to fit without padding
  const bestZoom = map.getBoundsZoom(bounds, false);
  const zoomTo = Math.min(bestZoom, map.getMaxZoom ? map.getMaxZoom() : 13);
  map.setView(bounds.getCenter(), zoomTo, { animate:false });
  // small fallback
  setTimeout(()=> {
    try{ map.fitBounds(bounds, { padding: FIT_PADDING, maxZoom: zoomTo, animate:false }); }catch(e){}
  }, 20);
}

/* load Austria geometry and regions */
let austriaBounds = null;
fetch(AUSTRIA_GEOJSON_FILE).then(r=>r.ok? r.json() : Promise.reject(r)).then(data=>{
  const bl = L.geoJSON(data, { style: austriaStyle }).addTo(map);
  austriaBounds = bl.getBounds();
  fitToBoundsTight(austriaBounds);
  // refit on resize
  window.addEventListener('resize', () => { if(window.__fit_timeout) clearTimeout(window.__fit_timeout); window.__fit_timeout = setTimeout(()=>fitToBoundsTight(austriaBounds), 160); });
}).catch(e => console.warn('bundeslaender.geojson load failed', e));

/* single-link priority list (first property that exists is opened) */
const LINK_FIELDS = ['url','website','link','homepage','href','site','portal','web','uri','home','slug'];

/* load regions (interactive) */
fetch(REGIONS_GEOJSON_FILE).then(r=>r.ok? r.json() : Promise.reject(r)).then(data=>{
  L.geoJSON(data, {
    style: regionStyle,
    onEachFeature: function(feature, layer){
      const name = feature.properties && (feature.properties.name || feature.properties.title) || '(Region)';
      layer.bindTooltip(name, { sticky:true, direction:'auto', pane:'tooltipPane' });
      layer.on('click', function(){
        const props = feature.properties || {};
        for(const k of LINK_FIELDS){
          if(props[k] && String(props[k]).trim().length){
            // slug special: if it's just a slug (no protocol/host), open as /slug
            if(k==='slug'){ openInTopWindow('/' + String(props[k]).trim()); return; }
            openInTopWindow(props[k]);
            return;
          }
        }
      });
    },
    pane: 'regionsPane'
  }).addTo(map);
}).catch(e => console.warn('regionen.geojson load failed', e));

/* Minimal legend (optional) */
const legend = L.control({ position: 'bottomright' });
legend.onAdd = function(){
  const d = L.DomUtil.create('div','legend');
  d.innerHTML = '<div><span class="swatch" style="background:'+COLOR_FORERUNNER+'"></span>Forerunner</div><div><span class="swatch" style="background:'+COLOR_FOLLOWER+'"></span>Follower</div>';
  return d;
};
legend.addTo(map);

</script>
</body>
</html>
