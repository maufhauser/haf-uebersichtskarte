<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HAF Übersichtskarte</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html,body { height:100%; margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #map { width:100%; height:100vh; } /* volle Höhe der Seite */
    .legend { background: white; padding:8px 10px; border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,0.15); font-size:14px; }
    .legend .item { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .legend .swatch { width:18px; height:12px; border-radius:2px; display:inline-block; }
    /* sichtbare Hover-Kante (wichtig: style-Vorzug per setStyle) */
    .region-hover { weight:3 !important; }
    /* pointer-cursor für interaktive Regionen */
    .leaflet-interactive { cursor: pointer; }
    /* Infobox oben links */
    .info-box {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      font-size: 14px;
      pointer-events: none; /* erlaubt Klicks auf Karte unter der Box */
    }
    @media (max-width:700px){
      .legend { font-size:13px; padding:6px 8px; }
    }
  </style>
</head>
<body>

<div id="map" role="application" aria-label="Interaktive Übersichtskarte"></div>
<div class="info-box" id="infobox">Bewege die Maus über eine Region</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===========================
   Konfiguration / Dateinamen
   =========================== */
const REGIONS_GEOJSON_FILE = 'regionen.geojson';        // muss im selben Ordner liegen
const AUSTRIA_GEOJSON_FILE = 'bundeslaender.geojson';  // optional

/* Farben */
const COLOR_FORERUNNER = "#d9534f"; // rot-ish
const COLOR_FOLLOWER   = "#0275d8"; // blau-ish
const COLOR_DEFAULT    = "#6c757d"; // grau

/* Infobox DOM */
const infoBox = document.getElementById('infobox');

/* Karte initialisieren */
const map = L.map('map', {
  minZoom: 6,
  maxZoom: 13,
  scrollWheelZoom: true
}).setView([47.5, 13.3], 7);

/* Basemap */
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

/* Style-Funktion (farbe nach properties.type) */
function styleByType(feature) {
  const t = (feature.properties && feature.properties.type || "").toLowerCase();
  let fill = COLOR_DEFAULT;
  if (t === 'forerunner') fill = COLOR_FORERUNNER;
  if (t === 'follower')   fill = COLOR_FOLLOWER;
  return {
    color: "#ffffff",
    weight: 1,
    fillColor: fill,
    fillOpacity: 0.65,
    dashArray: '',
    className: 'region-polygon' // leaflet-interactive wird trotzdem gesetzt
  };
}

/* Variablen für Layer, damit resetStyle möglich ist */
let regionsLayer = null;

/* Hilfsfunktion: sichere URL-Öffnung (öffnet extern in neuem Tab) */
function openUrlSafe(url) {
  if (!url || typeof url !== 'string' || url.trim() === '') return false;
  // einfache Heuristik: öffne absolute URLs als neue Tabs; relative URLs ebenfalls
  try {
    window.open(url, '_blank', 'noopener');
    return true;
  } catch (e) {
    // fallback: navigate same tab
    window.location.href = url;
    return true;
  }
}

/* Interaktion: Tooltip on hover, highlight, click -> URL */
function onEachRegion(feature, layer) {
  // Tooltip (Mouseover zeigt Namen)
  const name = (feature.properties && feature.properties.name) ? feature.properties.name : 'Region';
  layer.bindTooltip(name, {sticky: true, direction: 'auto'});

  layer.on({
    mouseover: function(e) {
      const target = e.target;
      target.setStyle({
        weight: 3,
        fillOpacity: 0.85
      });
      // bring to front for non-IE browsers
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        target.bringToFront();
      }
      // Infobox aktualisieren mit properties.name (falls vorhanden)
      infoBox.textContent = name;
    },
    mouseout: function(e) {
      // Reset to original style
      if (regionsLayer) regionsLayer.resetStyle(e.target);
      // Infobox zurücksetzen
      infoBox.textContent = 'Bewege die Maus über eine Region';
    },
    click: function(e) {
      const props = feature.properties || {};
      // Wenn props.url existiert -> öffne in neuem Tab (sicher)
      if (props.url && props.url.toString().trim().length > 0) {
        // Falls du stattdessen im gleichen Tab navigieren willst, ersetze openUrlSafe mit:
        // window.location.href = props.url;
        openUrlSafe(props.url.toString().trim());
        return;
      }
      // fallback: slug oder Name
      if (props.slug && props.slug.toString().trim().length > 0) {
        openUrlSafe('/' + props.slug.toString().trim());
        return;
      }
      // kein Link vorhanden -> zoome zur Region
      if (e.target && e.target.getBounds) {
        map.fitBounds(e.target.getBounds(), {padding:[20,20]});
      }
    }
  });
}

/* GeoJSON laden (Regions) */
fetch(REGIONS_GEOJSON_FILE)
  .then(resp => {
    if (!resp.ok) throw new Error('Fehler beim Laden der Regionen-Datei: ' + resp.status);
    return resp.json();
  })
  .then(data => {
    if (!data || !data.features) {
      console.error('Keine Features in Regionen-GeoJSON gefunden.');
      return;
    }

    regionsLayer = L.geoJSON(data, {
      style: styleByType,
      onEachFeature: onEachRegion
    }).addTo(map);

    // Fit to regions
    try {
      const b = regionsLayer.getBounds();
      if (b.isValid && !b.isEmpty()) map.fitBounds(b, {padding:[30,30]});
      // kleines invalidateSize, falls Karte in einem flex/hidden container gerendert wurde
      setTimeout(()=>map.invalidateSize(), 250);
    } catch(e){/* ignore */ }
  })
  .catch(err => {
    console.error(err);
    const wrapper = document.getElementById('map');
    const note = document.createElement('div');
    note.style.padding = '20px';
    note.style.color = '#a00';
    note.style.background = '#fff';
    note.style.maxWidth = '640px';
    note.style.margin = '20px auto';
    note.style.borderRadius = '6px';
    note.innerText = 'Die Regions-Datei konnte nicht geladen werden. Bitte prüfe, ob "regionen.geojson" im selben Ordner liegt.';
    wrapper.appendChild(note);
  });

/* Optional: Bundesländer-Grenzen als Outline (unschädlich, transparent innen) */
fetch(AUSTRIA_GEOJSON_FILE)
  .then(r => r.json())
  .then(d => {
    L.geoJSON(d, {
      style: function(){ return {color: '#333', weight: 1, fillOpacity: 0}; }
    }).addTo(map);
  }).catch(()=>{/* ignore */});

/* Legend */
const legend = L.control({position:'bottomright'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = '<strong>Legende</strong>';
  const add = (color,label) => {
    const item = document.createElement('div');
    item.className = 'item';
    const sw = document.createElement('span');
    sw.className = 'swatch';
    sw.style.background = color;
    const txt = document.createElement('span');
    txt.textContent = label;
    item.appendChild(sw);
    item.appendChild(txt);
    div.appendChild(item);
  };
  add(COLOR_FORERUNNER, 'Forerunner-Region');
  add(COLOR_FOLLOWER, 'Follower-Region');
  return div;
};
legend.addTo(map);

/* Accessibility: Enter öffnet Link der Region unter der Bildschirmmitte (best-effort) */
document.addEventListener('keydown', function(e){
  if (e.key === 'Enter') {
    if (!regionsLayer) return;
    const center = map.getCenter();
    // prüfe welches Feature das Zentrum enthält
    regionsLayer.eachLayer(function(layer){
      if (layer.feature && layer.getBounds && layer.getBounds().contains(center)) {
        const props = layer.feature.properties || {};
        if (props.url) openUrlSafe(props.url);
      }
    });
  }
});
</script>
</body>
</html>
